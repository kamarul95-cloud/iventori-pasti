<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistem Inventori (Proxy)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<style>
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,sans-serif;background:#f4f4f4}
  #sidebar{width:200px;height:100vh;background:#2c3e50;color:#fff;float:left;padding-top:20px}
  .menu-item{padding:12px 15px;cursor:pointer;border-bottom:1px solid #34495e}
  .menu-item:hover,.menu-item.active{background:#34495e}
  #main-area{margin-left:200px;padding:28px}
  .content-view{display:none} .content-view.active{display:block}
  table{width:100%;border-collapse:collapse} th,td{border:1px solid #ccc;padding:10px;text-align:left}
  th{background:#ecf0f1} .low-stock{background:#fce7e7;color:#c0392b;font-weight:700}
  .btn-action{padding:6px 10px;border-radius:4px;border:0;margin-right:6px;cursor:pointer}
  .edit{background:#3498db;color:#fff} .delete{background:#e74c3c;color:#fff}
  label{display:inline-block;width:150px;text-align:right;margin-right:10px}
  input[type="text"],input[type="number"]{padding:8px;width:250px;border:1px solid #ccc;border-radius:4px;margin-bottom:10px}
</style>
</head>
<body>
  <div id="sidebar">
    <div style="text-align:center;padding-bottom:18px;font-weight:700">Inventory Manager</div>
    <div class="menu-item active" id="nav-dashboard" onclick="showView('dashboard')">üè† Dashboard</div>
    <div class="menu-item" id="nav-stock" onclick="showView('stock')">üì¶ Stock Items</div>
    <div class="menu-item" id="nav-add" onclick="showView('add')">‚ûï Tambah Produk</div>
  </div>

  <div id="main-area">
    <div id="dashboard" class="content-view active">
      <h2>Dashboard</h2>
      <p>Klik <strong>Stock Items</strong> untuk muatkan data dari Google Sheet.</p>
    </div>

    <div id="stock" class="content-view">
      <h2>Senarai Stok Produk</h2>
      <button onclick="prepareAddForm()" style="float:right;margin-bottom:10px;background:#2ecc71;color:#fff;padding:8px 12px;border-radius:6px;border:0">+ Tambah Produk</button>
      <div id="product-table-container"><p>Memuatkan data...</p></div>
      <div style="clear:both"></div>
    </div>

    <div id="add" class="content-view">
      <h2 id="form-title">‚ûï Tambah Produk</h2>
      <form id="addProductForm" onsubmit="handleFormSubmit(event)">
        <input type="hidden" id="form-action" value="addProduct">
        <label for="sku">SKU:</label><input id="sku" name="sku" type="text" required><br>
        <label for="name">Nama Produk:</label><input id="name" name="name" type="text" required><br>
        <label for="quantity">Kuantiti:</label><input id="quantity" name="quantity" type="number" min="0" required><br>
        <label for="cost">Harga Belian (RM):</label><input id="cost" name="cost" type="number" step="0.01" min="0" required><br>
        <label for="price">Harga Jualan (RM):</label><input id="price" name="price" type="number" step="0.01" min="0" required><br>
        <button id="form-submit-btn" type="submit" style="background:#2ecc71;color:#fff;padding:8px 12px;border-radius:6px;border:0">Simpan</button>
      </form>
      <div id="form-status" style="margin-top:12px;font-weight:700"></div>
    </div>
  </div>

<script>
/* ========== CONFIG (GANTI INI) ========== */
const PROXY_URL = "https://iventori-proxy-v2-990ecz89e-kamaruls-projects-03596125.vercel.app"; // contoh: https://iventori-proxy-v2-xxxx.vercel.app
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTgoIbqldOdwiW1qXp_m_iECMPaxxAnyLG7knRJqiImBeId945SYpwxeJPRPnEDK4gVHXMZ9oFgW8Tj/pub?gid=0&single=true&output=csv"; // contoh Google Sheets publish CSV
/* ======================================== */

let allProductData = [];

function showView(id){
  document.querySelectorAll('.content-view').forEach(v=>v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active'));
  if(id==='dashboard') document.getElementById('nav-dashboard').classList.add('active');
  if(id==='stock'){ document.getElementById('nav-stock').classList.add('active'); loadStockData(); }
  if(id==='add') document.getElementById('nav-add').classList.add('active');
}

function loadStockData(){
  const container = document.getElementById('product-table-container');
  container.innerHTML = `<p>Memuat turun data dari Google Sheet...</p>`;
  if(!CSV_URL || CSV_URL.indexOf('http')!==0){
    container.innerHTML = `<p style="color:darkred">SILA GANTI CSV_URL DALAM KONFIG.</p>`; return;
  }
  Papa.parse(CSV_URL, {
    download:true, header:false, skipEmptyLines:true,
    complete: function(results){
      let data = results.data || [];
      // assume CSV columns: SKU, Nama, Kuantiti, HargaBelian, HargaJualan (kolum 0..4)
      allProductData = data.filter(r => r && r.length >= 5 && (r[0]||'').toString().trim() !== '');
      displayProducts(allProductData);
    },
    error: function(err){
      container.innerHTML = `<p style="color:red">‚ùå Ralat CSV: ${err.message}</p>`;
    }
  });
}

function displayProducts(data){
  const container = document.getElementById('product-table-container');
  if(!data || data.length===0){ container.innerHTML = `<p style="color:darkred">Tiada data produk ditemui.</p>`; return; }
  let html = '<table><thead><tr><th>SKU</th><th>Nama</th><th>Kuantiti</th><th>Harga Belian</th><th>Harga Jualan</th><th>Tindakan</th></tr></thead><tbody>';
  data.forEach(row=>{
    const sku = (row[0]||'').toString();
    const nama = row[1]||'';
    const qty = row[2]||0;
    const cost = row[3]||'';
    const price = row[4]||'';
    const qtyNum = parseInt(qty)||0;
    const cls = qtyNum < 10 ? 'low-stock' : '';
    const safeRow = JSON.stringify([sku,nama,qty,cost,price]);
    html += `<tr class="${cls}"><td>${sku}</td><td>${nama}</td><td>${qty}</td><td>${cost}</td><td>${price}</td><td>
      <button class="btn-action edit" onclick='editItem(${safeRow})'>Edit</button>
      <button class="btn-action delete" onclick='deleteItem("${sku}")'>Hapus</button>
    </td></tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

/* ========== writeProduct: panggil proxy (tidak direct ke GAS) ========== */
async function writeProduct(action, productData){
  const statusDiv = document.getElementById('form-status');
  statusDiv.innerText = 'Menghantar data ke server...';
  document.getElementById('form-submit-btn').disabled = true;

  try{
    const res = await fetch(PROXY_URL + '/api/products', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action, data: productData })
    });
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const j = await res.json();
    if(j.status === 'success' || j.result === 'success'){
      statusDiv.innerHTML = `<span style="color:green">‚úÖ ${j.message || j.msg || 'Operasi berjaya'}</span>`;
      if(action === 'addProduct') document.getElementById('addProductForm').reset();
      setTimeout(()=>loadStockData(),700);
      if(action === 'editProduct') setTimeout(()=>showView('stock'),800);
    } else {
      statusDiv.innerHTML = `<span style="color:red">‚ùå ${j.message || j.msg || 'Operasi gagal'}</span>`;
    }
  }catch(err){
    statusDiv.innerHTML = `<span style="color:red">‚ùå ${err.toString()}</span>`;
    console.error('writeProduct error', err);
  }finally{
    document.getElementById('form-submit-btn').disabled = false;
  }
}

/* ========== form handlers ========== */
function prepareAddForm(){
  document.getElementById('form-title').innerText = '‚ûï Tambah Produk';
  document.getElementById('addProductForm').reset();
  document.getElementById('form-action').value = 'addProduct';
  document.getElementById('sku').disabled = false;
  document.getElementById('form-status').innerText = '';
  showView('add');
}

function editItem(row){
  // row = [sku,nama,qty,cost,price]
  document.getElementById('form-title').innerText = '‚úèÔ∏è Kemaskini Produk';
  document.getElementById('addProductForm').reset();
  document.getElementById('form-action').value = 'editProduct';
  document.getElementById('sku').value = row[0];
  document.getElementById('sku').disabled = true;
  document.getElementById('name').value = row[1];
  document.getElementById('quantity').value = row[2];
  document.getElementById('cost').value = row[3];
  document.getElementById('price').value = row[4];
  document.getElementById('form-status').innerText = '';
  showView('add');
}

async function deleteItem(sku){
  if(!confirm(`Anda pasti mahu memadam produk ${sku}?`)) return;
  await writeProduct('deleteProduct', { sku });
}

async function handleFormSubmit(e){
  e.preventDefault();
  const f = document.getElementById('addProductForm');
  const action = document.getElementById('form-action').value;
  const productData = {
    sku: f.sku.value.trim(),
    name: f.name.value.trim(),
    quantity: parseInt(f.quantity.value,10) || 0,
    cost: parseFloat(f.cost.value) || 0,
    price: parseFloat(f.price.value) || 0
  };
  if(!productData.sku){ document.getElementById('form-status').innerHTML = '<span style="color:red">Sila isi SKU.</span>'; return; }
  await writeProduct(action, productData);
}

/* init */
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('addProductForm').addEventListener('submit', handleFormSubmit);
  showView('dashboard');
});
</script>
</body>
</html>
